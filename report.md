# 排课算法报告

## 问题抽象
- 将“学生-实验组”视为带容量的二分图匹配问题：一侧为学生，另一侧为实验组；匹配边受时间、容量、项目唯一性等约束。
- 学时需求形成“多重匹配”要求：每个学生需要若干条满足总课时的边。
- 时间冲突判定使用集合与区间运算：周次集合交集、星期相等且节次区间重叠视为冲突。

## 最新改进（同班/专业聚合）
- 评分函数加入可调权重：`w_class` 强化同班/同专业聚合，`w_hetero` 惩罚组内班级/专业的异质度，`w_spread`、`w_slot`、`w_occupancy` 分别控制周次分散、同一时段偏好与容量均衡。
- 同班占比以“同班/专业人数 ÷ (组内人数+1)”计，避免大组无限增益；异质度用“不同班级/专业数量 ÷ 组内人数”衡量。
- 增加局部交换（默认 200 次尝试）：在不违反硬约束且不降学时的前提下，随机交换两名学生的实验组，如果能降低两组的班级/专业异质度则接受，从而进一步把同班同专业聚到一起。
- CLI 可调参数示例：`--w-class 1.2 --w-hetero 0.6 --swap-iterations 300`。

## 使用的离散数学知识
1. **集合运算**：
   - 周次解析后形成周集合 $W$，冲突检测依赖集合交集 $W_a \cap W_b$ 是否为空。
2. **区间与排列**：
   - 节次视为闭区间 $[s, e]$，冲突条件是两个区间有交集，即 $\neg (e_a < s_b \lor e_b < s_a)$。
3. **图模型与匹配思想**：
   - 学生-实验组构成二分图 $G=(U, V, E)$，容量约束相当于对 $V$ 顶点的度上限；学时需求相当于每个 $u\in U$ 需要至少 $k$ 条边（$k$ 取决于课时与需求比）。
   - 由于需求量大且存在多重匹配，直接求最大流/匹配复杂度较高，采用启发式贪心近似。
4. **贪心策略与评分函数**：
   - 评分项：
     - 容量均衡（负载率）——避免局部挤占，满足“均匀分布空余”。
     - 同班/同专业聚合——提高同组同源一致性，响应 B8。
     - 周次离散度——最小周次差的负值，鼓励学期内分散，响应 B7。
     - 时段一致性——相同星期与节次优先，方便学生成块上课，响应 B9。
   - 每次为学生挑选评分最小的可行实验组，直到学时满足或无可选组。
5. **可行性与容量判断**：
   - 总需求与供给的比较相当于对图的度约束进行可行性预检查：如果 $\sum_V \text{capacity}\times hours < |U| \times \text{required\_hours}$，则不存在满配解。

## 算法流程
1. 解析 Excel，构造时间片 $T=(W, d, s, e)$。
2. 为每位学生收集忙碌时间集合 $B_u$（仅理论课）。
3. 构造实验组列表 $V$ 及剩余容量。
4. 将学生按班级/专业分组，组内随机打散后依次处理。
5. 为学生筛选可行实验组（不冲突、未满员、未重复项目），按评分排序取最优，直至达标或无解。
6. 完成贪心分配后，进行若干轮局部交换，降低组内班级/专业的异质度而不破坏硬约束。
7. 统计结果，生成 CSV，输出未满足学时的名单。

## 复杂度分析
- 解析阶段：$O(n + m)$，其中 $n$ 为学生课表行，$m$ 为实验组行。
- 分配阶段：最坏情况下，对每名学生遍历全部实验组，复杂度 $O(|U||V|\log|V|)$（排序主导）。数据量下可接受。

## 供需可行性
- 本次数据：学生 2888 人，需要 $86{,}640$ 学时；实验总供给 $91{,}152$ 学时，供给大于需求。
- 因此贪心排课可全部满足学时，最终无未达标学生。

## 改进方向
1. 若补足供给，可采用**最大流/最小费用流**建模，精确满足 B 类优化目标。
2. 增加“专业-实验项目”权重矩阵，支持 C 类偏好（优先或避免特定专业与项目组合）。
3. 将当前局部交换扩展为模拟退火/禁忌搜索，并叠加“容量平衡”与“时间块化”作为多目标。
4. 输出未达标学生的可行候选列表，为人工调剂提供直接选项。
